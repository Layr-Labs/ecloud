{{#if includeTLS}}
# Get Caddy from official image
FROM caddy:2.10.2-alpine AS caddy
{{/if}}

FROM {{baseImage}}

{{#if originalUser}}
# Switch to root to perform setup (base image has non-root USER: {{originalUser}})
USER root
{{/if}}

# Copy core TEE components
COPY compute-source-env.sh /usr/local/bin/
COPY kms-client /usr/local/bin/
COPY kms-encryption-public-key.pem /usr/local/bin/
COPY kms-signing-public-key.pem /usr/local/bin/

{{#if includeTLS}}
# Copy Caddy from official image
COPY --from=caddy /usr/bin/caddy /usr/local/bin/caddy

# Copy TLS components
COPY tls-keygen /usr/local/bin/
COPY Caddyfile /etc/caddy/
{{/if}}

{{#if originalUser}}
# Make binaries executable (755 for executables, 644 for keys)
RUN chmod 755 /usr/local/bin/compute-source-env.sh \
    && chmod 755 /usr/local/bin/kms-client{{#if includeTLS}} \
    && chmod 755 /usr/local/bin/tls-keygen \
    && chmod 755 /usr/local/bin/caddy{{/if}} \
    && chmod 644 /usr/local/bin/kms-encryption-public-key.pem \
    && chmod 644 /usr/local/bin/kms-signing-public-key.pem

# Switch back to the original user from base image
USER {{originalUser}}
{{else}}
# Make binaries executable (preserve existing permissions, just add execute)
RUN chmod +x /usr/local/bin/compute-source-env.sh \
    && chmod +x /usr/local/bin/kms-client{{#if includeTLS}} \
    && chmod +x /usr/local/bin/tls-keygen{{/if}}
{{/if}}

{{#if logRedirect}}

LABEL tee.launch_policy.log_redirect={{logRedirect}}
{{/if}}

LABEL eigenx_cli_version={{ecloudCLIVersion}}

{{#if includeTLS}}
# Expose both HTTP and HTTPS ports for Caddy
EXPOSE 80 443
{{/if}}

ENTRYPOINT ["/usr/local/bin/compute-source-env.sh"]
CMD {{{originalCmd}}}
